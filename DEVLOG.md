# 기능 구현 문서 (Feature Documentation)
해당 문서는 프로젝트 진행 중 구현한 기능들의 동작 흐름과 데이터 처리 구조를 정리한 개발 문서입니다.

---

## 결제하기 구조
프론트→ paymentKey, orderId, amount, user_id 등 결제정보를 API로 보내기
Superbase Edge Function → Supabase DB insert
전체 흐름: React → Edge Function → Supabase DB

```
[React]
useEffect → fetch(save-order)

       ↓

[Supabase Edge Function]
- user_id 파악 가능
- DB insert

       ↓

[Supabase DB]
OrdersHeaders 테이블에 저장
```

## Front => Edge Functions API => Supabase DB 데이터 전송 플로우 (2가지)
첫번째 (상품 상세페이지 1:1 데이터 전송)

```
- 1. 상품 구매 클릭 시 토스페이먼츠 API로 인자값 전달 (상품 정보는 객체에서 배열로 변환하여 전송)
- 2. 토스페이먼츠 API코드에서 결제페이지로 전달하는 인자값에 추가하는것이 아닌 세션스토리지에 JSON 문자열로 저장
- 3. 결제 성공 페이지에서 세션스토리지에 저장한 요소를 꺼내어 JSON 배열로 변환 후 변수에 할당 후 state에도 할당
- 4. 백엔드 서버로 fetch할 때 변수에 할당한 요소도 body의 인자값으로 전달 & 전달 후 더미데이터가 된 세션스토리지 요소는 제거
- 5. 프론트 에서 fetch한 데이터를 백엔드에서 받고 2개의 테이블에 각각 전송 (상품정보 테이블 & 구매내역 정보 테이블)
- 6. 백엔드 서버에서 배열로 담겨진 상품정보 변수에 map()을 사용하여 배열 안 각 객체에 key-value값을 할당 후 insert 
- (객체에게 key-value값을 지정 해주었으니 해당 key명과 일치하는 컬럼에 value값이 할당 됨)
- (1:1 상품은 어차피 객체여서 변환하지 않아도 되지만 백엔드에서 받을 데이터명과 데이터 구조를 통일  & 재사용성을 고려하여 둘 다 배열로 통일)
```

두번째 (장바구니 1:N  데이터 전송)

```
- 1. 상품 구매 클릭 시 토스페이먼츠 API로 인자값 전달 (상품 정보는 기존 cart변수에 담긴 배열에 map을 돌려 cart변수 안에 들어 있는 각각의 객체에게 key값과 value값을 지정해준 후 모든 객체를 하나의 배열로 감싸 인자값으로 전달)
- 2. 토스페이먼츠 API코드에서 결제페이지로 전달하는 인자값에 추가하는것이 아닌 세션스토리지에 JSON 문자열로 저장
- 3. 결제 성공 페이지에서 세션스토리지에 저장한 요소를 꺼내어 JSON 배열로 변환 후 변수에 할당 후 state에도 할당
- 4. 백엔드 서버로 fetch할 때 변수에 할당한 요소도 body의 인자값으로 전달 후 더미데이터가 된 세션스토리지 요소는 제거
- 5. 프론트 에서 fetch한 데이터를 백엔드에서 받고 2개의 테이블에 각각 전송 (상품정보 테이블 & 구매내역 정보 테이블)
- 6. 백엔드 서버에서 배열로 담겨진 상품정보 변수에 map()을 사용하여 배열 안 각 객체에 key-value값을 할당 후 insert 
- (객체에게 key-value값을 지정 해주었으니 해당 key명과 일치하는 컬럼에 value값이 할당 됨)
```

공통 개념 정리
(1:1 & 1:N을 둘다 배열 형태로 전송하는 이유는 데이터의 통일성 때문)
- 객체와 배열 어느 타입으로 전송 하던 상관없지만 데이터의 통일을 해두면 유지보수나 코드 작성에도 효율적임

(세선스토리지에 문자열로 저장하는 이유)
- 로컬스토리지 & 세션스토리지는 key-value를 문자열로만 보관 함

---
